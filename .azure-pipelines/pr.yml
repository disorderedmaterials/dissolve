trigger: none

pr:
  autoCancel: true
  branches:
    include:
      - "*"
  paths:
    exclude:
    - examples/*
    - scripts/*
    - web/*
    - README.md
    - .azure-pipelines/continuous.yml
    - .azure-pipelines/release.yml

stages:
  - template: templates/code-quality-checks.yml

  # Build Executables
  - stage: "build"
    displayName: "Build"
    jobs:
      - job: "release_linux_mpi"
        displayName: "Testing MPI, CLI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "dissolve-mpi"
      - job: "release_linux_gui"
        displayName: "Testing GUI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "dissolve"
      - job: "release_linux_threadless"
        displayName: "Testing Threadless"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "dissolve-threadless"
      - job: "test_linux_mpi"
        displayName: "Testing MPI, CLI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "checks.x86_64-linux.dissolve-mpi"
      - job: "test_linux_gui"
        displayName: "Testing GUI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "checks.x86_64-linux.dissolve"
      - job: "test_linux_threadless"
        displayName: "Testing Threadless"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "checks.x86_64-linux.dissolve-threadless"
      - job: "osx"
        displayName: "OSX, Threads, CLI/GUI"
        timeoutInMinutes: 120
        pool:
          vmImage: "macos-latest"
        condition: eq(true, false)
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-osx.yml
          - template: templates/package-osx.yml
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "packages/"
              ArtifactName: "osx-artifacts"
            displayName: "Publish OSX Artifacts"
      - job: "windows"
        displayName: "Windows, Threads, CLI/GUI"
        timeoutInMinutes: 120
        pool:
          vmImage: "windows-latest"
        condition: eq(true, false)
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-windows.yml
          - template: templates/package-windows.yml
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "packages/"
              ArtifactName: "windows-artifacts"
            displayName: "Publish Windows Artifacts"

  - stage: "Package"
    displayName: "Packaging"
    jobs:
      - job: "linux"
        displayName: "Ubuntu, Threads, CLI/GUI, Singularity"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              export: true
              exportSingularity: false
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "packages/"
              ArtifactName: "linux-GUI-artifacts"
            displayName: "Publish Linux GUI Artifacts"
      - job: "linux"
        displayName: "Ubuntu, Threads, CLI/GUI, Executable"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              export: true
              exportExe: false
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "singularity/"
              ArtifactName: "gui-singularity"
            displayName: "Publish Linux GUI Singularity"
      - job: "linux_serial"
        displayName: "Ubuntu, Serial, CLI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "dissolve"
              docker: "docker"
              singularity: "singularity"
              export: true
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "packages/"
              ArtifactName: "linux-cli-artifacts"
            displayName: "Publish Linux CLI Artifacts"
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "docker/"
              ArtifactName: "linux-cli-docker"
            displayName: "Publish Linux CLI Docker"
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "singularity/"
              ArtifactName: "cli-singularity"
            displayName: "Publish Linux CLI Singularity"
      - job: "linux_mpi"
        displayName: "Ubuntu, MPI, CLI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 1
          - template: templates/set-short-hash.yml
          - template: templates/build-linux.yml
            parameters:
              package: "dissolve-mpi"
              docker: "docker-mpi"
              singularity: "singularity-mpi"
              export: true
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "packages/"
              ArtifactName: "mpi-artifacts"
            displayName: "Publish MPI Artifacts"
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "docker/"
              ArtifactName: "mpi-docker"
            displayName: "Publish MPI Docker"
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "singularity/"
              ArtifactName: "mpi-singularity"
            displayName: "Publish Linux MPI Singularity"
