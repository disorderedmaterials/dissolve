name: Build

inputs:
  extraCMakeFlags:
    default: ""
  target:
    default: "dissolve"

runs:
  using: "composite"
  steps:

  - name: Install nix
    uses: "./.github/workflows/get-nix"
    with:
      target: ${{ inputs.target }}

  - name: Build
    shell: bash
    run: |
      set -ex

      # Build
      nix build -L .#${{ inputs.target }}
      nix build --json .#${{ inputs.target }} > archive.json

  - name: Bundle
    shell: bash
    run: |
      set -ex

      nix bundle -L .#${{ inputs.target }} -o ${{ inputs.target }}
      ls -R ${{ inputs.target }}

      # Assemble artifacts
      mkdir build
      cp -v ${{ inputs.target }} build/${{ inputs.target }}-${{ env.dissolveVersion }}

  - name: Upload Raw Build Artifacts
    uses: actions/upload-artifact@v3
    with:
      name: linux-build-artifacts-${{ inputs.target }}
      path: ${{ github.workspace }}/build
      retention-days: 1
