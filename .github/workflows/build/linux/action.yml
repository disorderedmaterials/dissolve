name: Build
description: Build on Linux via nix

inputs:
  extraCMakeFlags:
    default: ""
  target:
    default: "dissolve"
  cacheOnly:
    type: boolean
    default: false

runs:
  using: "composite"
  steps:

  - name: Install nix
    uses: "./.github/workflows/get-nix"
    with:
      target: ${{ inputs.target }}

  - name: Build
    shell: bash
    run: |
      set -ex

      # Build Singularity target
      target=${{ inputs.target }}
      singularityTarget=${target/dissolve/singularity}
      nix build -L .#$singularityTarget
      nix build --json .#$singularityTarget > archive.json

      # Assemble artifacts
      mkdir packages
      cp -v result packages/${{ inputs.target }}-${{ env.dissolveVersion }}.sif

  - name: Bundle Executable
    if: ${{ inputs.cacheOnly == 'false' }}
    shell: bash
    run: |
      set -ex

      nix bundle -L .#${{ inputs.target }} -o binary

      # Assemble artifacts
      cp -v binary packages/${{ inputs.target }}-${{ env.dissolveVersion }}

  - name: Tidy nix Store
    if: ${{ inputs.cacheOnly == 'true' }}
    shell: bash
    run: |
      set -ex
      # Remove the built dissolve derivations / img from the nix store to save space and leave just the other core build deps
      for a in `nix path-info --all | grep dissolve`
      do
        nix --extra-experimental-features nix-command store delete --ignore-liveness $a
      done

  - name: Upload Package Artifacts
    if: ${{ inputs.cacheOnly == 'false' }}
    uses: actions/upload-artifact@v3
    with:
      name: packages
      path: ${{ github.workspace }}/packages
