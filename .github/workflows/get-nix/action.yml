name: Get Nix
description: Install and cache nix

inputs:
  target:
    default: "dissolve"

runs:
  using: "composite"
  steps:

  - name: Cache Nix Store
    uses: actions/cache@v3
    id: nix-cache
    with:
      path: /tmp/nixcache
      key: ${{ runner.os }}-nix-cache

  - name: Install Nix
    uses: cachix/install-nix-action@v15
    with:
      nix_path: nixpkgs=channel:nixos-unstable
      extra_nix_config: "system-features = nixos-test benchmark big-parallel kvm"

  - name: Import Nix Store Cache
    if: "steps.nix-cache.outputs.cache-hit == 'true'"
    shell: bash
    run: nix-store --import < /tmp/nixcache

  - name: Export Nix Store Cache
    if: "steps.nix-cache.outputs.cache-hit != 'true'"
    shell: bash
    run: nix-store --export $(find /nix/store -maxdepth 1 -name '*-*') > /tmp/nixcache
